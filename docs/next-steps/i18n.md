# Implementaci贸n de Internacionalizaci贸n (i18n) con Rosetta

## Informaci贸n del Proyecto
- **Aplicaci贸n**: LuxSequencer - Generador de patrones visuales en tiempo real
- **Framework**: React 19 + Vite + Zustand + TypeScript
- **Patr贸n de carga**: Carga inicial 煤nica, aplicaci贸n permanece en memoria
- **Prioridad**: Rendimiento runtime sobre bundle size

## Biblioteca Seleccionada: rosetta

**Razones de elecci贸n:**
- Ultra ligero (~2KB)
- Runtime ultrarr谩pido (lookups instant谩neos)
- Perfecto para aplicaciones de tiempo real
- API simple y directa
- Carga inicial completa de traducciones

## 1. Instalaci贸n

```bash
npm install rosetta
npm install @types/rosetta --save-dev  # Si necesario
```

## 2. Estructura de Archivos a Crear

```
src/i18n/
 index.ts              # Configuraci贸n principal de rosetta
 translations.ts       # Todas las traducciones
 types.ts              # Types de TypeScript para i18n
 hooks/
     useTranslation.ts # Hook personalizado para React
```

## 3. Archivos a Implementar

### 3.1. `src/i18n/types.ts`

```typescript
export interface TranslationKeys {
  // Common
  'common.loading': string
  'common.error': string
  'common.success': string
  'common.cancel': string
  'common.save': string
  'common.delete': string
  'common.close': string
  
  // Header
  'header.renderer': string
  'header.viewport': string
  'header.midi': string
  'header.fullscreen': string
  'header.settings': string
  'header.sequencer': string
  
  // Sequencer
  'sequencer.play': string
  'sequencer.stop': string
  'sequencer.bpm': string
  'sequencer.steps': string
  'sequencer.patterns': string
  'sequencer.addPattern': string
  'sequencer.saveCurrentPattern': string
  'sequencer.loadPattern': string
  'sequencer.deletePattern': string
  'sequencer.interpolationSpeed': string
  'sequencer.propertySequencer': string
  'sequencer.addTrack': string
  
  // Controls
  'controls.scaleSize': string
  'controls.animationSpeed': string
  'controls.borderSize': string
  'controls.borderColor': string
  'controls.scaleGradient': string
  'controls.backgroundGradient': string
  'controls.rotationSpeed': string
  'controls.opacity': string
  'controls.blendMode': string
  'controls.hexRadius': string
  'controls.concentricLayers': string
  
  // MIDI
  'midi.learn': string
  'midi.learning': string
  'midi.mapped': string
  'midi.console': string
  'midi.connectDevice': string
  'midi.noDevices': string
  'midi.clearMappings': string
  
  // Project
  'project.new': string
  'project.load': string
  'project.save': string
  'project.export': string
  'project.import': string
  'project.name': string
  'project.defaultName': string
  
  // Renderers
  'renderer.webgl': string
  'renderer.canvas2d': string
  'renderer.concentric': string
  
  // Sections
  'section.scale': string
  'section.animation': string
  'section.appearance': string
  'section.background': string
  'section.border': string
  'section.concentric': string
  
  // Viewport
  'viewport.default': string
  'viewport.desktop': string
  'viewport.mobile': string
  
  // Debug
  'debug.overlay': string
  'debug.fps': string
  'debug.ticks': string
  'debug.step': string
  'debug.animations': string
  'debug.export': string
  
  // Validation/Errors
  'error.loadProject': string
  'error.saveProject': string
  'error.midiAccess': string
  'error.invalidProject': string
}

export type LocaleCode = 'en' | 'es'

export interface TranslationParams {
  [key: string]: string | number
}
```

### 3.2. `src/i18n/translations.ts`

```typescript
import type { TranslationKeys, LocaleCode } from './types'

export const translations: Record<LocaleCode, TranslationKeys> = {
  en: {
    // Common
    'common.loading': 'Loading...',
    'common.error': 'Error',
    'common.success': 'Success',
    'common.cancel': 'Cancel',
    'common.save': 'Save',
    'common.delete': 'Delete',
    'common.close': 'Close',
    
    // Header
    'header.renderer': 'Renderer',
    'header.viewport': 'Viewport',
    'header.midi': 'MIDI Console',
    'header.fullscreen': 'Fullscreen',
    'header.settings': 'Settings',
    'header.sequencer': 'Sequencer',
    
    // Sequencer
    'sequencer.play': 'Play',
    'sequencer.stop': 'Stop',
    'sequencer.bpm': 'BPM: {{value}}',
    'sequencer.steps': 'Steps: {{count}}',
    'sequencer.patterns': 'Patterns',
    'sequencer.addPattern': 'Add Pattern',
    'sequencer.saveCurrentPattern': 'Save Current Pattern',
    'sequencer.loadPattern': 'Load Pattern',
    'sequencer.deletePattern': 'Delete Pattern',
    'sequencer.interpolationSpeed': 'Interpolation Speed',
    'sequencer.propertySequencer': 'Property Sequencer',
    'sequencer.addTrack': 'Add Track',
    
    // Controls
    'controls.scaleSize': 'Scale Size',
    'controls.animationSpeed': 'Animation Speed',
    'controls.borderSize': 'Border Size',
    'controls.borderColor': 'Border Color',
    'controls.scaleGradient': 'Scale Gradient',
    'controls.backgroundGradient': 'Background Gradient',
    'controls.rotationSpeed': 'Rotation Speed',
    'controls.opacity': 'Opacity',
    'controls.blendMode': 'Blend Mode',
    'controls.hexRadius': 'Hexagon Radius',
    'controls.concentricLayers': 'Concentric Layers',
    
    // MIDI
    'midi.learn': 'MIDI Learn',
    'midi.learning': 'Learning...',
    'midi.mapped': 'Mapped to CC{{cc}}',
    'midi.console': 'MIDI Console',
    'midi.connectDevice': 'Connect MIDI Device',
    'midi.noDevices': 'No MIDI devices found',
    'midi.clearMappings': 'Clear All Mappings',
    
    // Project
    'project.new': 'New Project',
    'project.load': 'Load Project',
    'project.save': 'Save Project',
    'project.export': 'Export Project',
    'project.import': 'Import Project',
    'project.name': 'Project Name',
    'project.defaultName': 'LuxSequencer Project',
    
    // Renderers
    'renderer.webgl': 'WebGL Scale',
    'renderer.canvas2d': 'Canvas 2D Scale',
    'renderer.concentric': 'Concentric Hexagons',
    
    // Sections
    'section.scale': 'Scale Settings',
    'section.animation': 'Animation',
    'section.appearance': 'Appearance',
    'section.background': 'Background',
    'section.border': 'Border',
    'section.concentric': 'Concentric Settings',
    
    // Viewport
    'viewport.default': 'Default',
    'viewport.desktop': 'Desktop (1920x1080)',
    'viewport.mobile': 'Mobile (390x844)',
    
    // Debug
    'debug.overlay': 'Debug Overlay',
    'debug.fps': 'FPS: {{value}}',
    'debug.ticks': 'Ticks: {{count}}',
    'debug.step': 'Step: {{current}}/{{total}}',
    'debug.animations': 'Active Animations: {{count}}',
    'debug.export': 'Export Debug Data',
    
    // Validation/Errors
    'error.loadProject': 'Failed to load project',
    'error.saveProject': 'Failed to save project',
    'error.midiAccess': 'MIDI access denied',
    'error.invalidProject': 'Invalid project format'
  },
  
  es: {
    // Common
    'common.loading': 'Cargando...',
    'common.error': 'Error',
    'common.success': 'xito',
    'common.cancel': 'Cancelar',
    'common.save': 'Guardar',
    'common.delete': 'Eliminar',
    'common.close': 'Cerrar',
    
    // Header
    'header.renderer': 'Renderizador',
    'header.viewport': 'Vista',
    'header.midi': 'Consola MIDI',
    'header.fullscreen': 'Pantalla Completa',
    'header.settings': 'Configuraci贸n',
    'header.sequencer': 'Secuenciador',
    
    // Sequencer
    'sequencer.play': 'Reproducir',
    'sequencer.stop': 'Parar',
    'sequencer.bpm': 'BPM: {{value}}',
    'sequencer.steps': 'Pasos: {{count}}',
    'sequencer.patterns': 'Patrones',
    'sequencer.addPattern': 'A帽adir Patr贸n',
    'sequencer.saveCurrentPattern': 'Guardar Patr贸n Actual',
    'sequencer.loadPattern': 'Cargar Patr贸n',
    'sequencer.deletePattern': 'Eliminar Patr贸n',
    'sequencer.interpolationSpeed': 'Velocidad de Interpolaci贸n',
    'sequencer.propertySequencer': 'Secuenciador de Propiedades',
    'sequencer.addTrack': 'A帽adir Pista',
    
    // Controls
    'controls.scaleSize': 'Tama帽o de Escala',
    'controls.animationSpeed': 'Velocidad de Animaci贸n',
    'controls.borderSize': 'Tama帽o del Borde',
    'controls.borderColor': 'Color del Borde',
    'controls.scaleGradient': 'Gradiente de Escala',
    'controls.backgroundGradient': 'Gradiente de Fondo',
    'controls.rotationSpeed': 'Velocidad de Rotaci贸n',
    'controls.opacity': 'Opacidad',
    'controls.blendMode': 'Modo de Mezcla',
    'controls.hexRadius': 'Radio del Hex谩gono',
    'controls.concentricLayers': 'Capas Conc茅ntricas',
    
    // MIDI
    'midi.learn': 'Aprender MIDI',
    'midi.learning': 'Aprendiendo...',
    'midi.mapped': 'Asignado a CC{{cc}}',
    'midi.console': 'Consola MIDI',
    'midi.connectDevice': 'Conectar Dispositivo MIDI',
    'midi.noDevices': 'No se encontraron dispositivos MIDI',
    'midi.clearMappings': 'Limpiar Todas las Asignaciones',
    
    // Project
    'project.new': 'Nuevo Proyecto',
    'project.load': 'Cargar Proyecto',
    'project.save': 'Guardar Proyecto',
    'project.export': 'Exportar Proyecto',
    'project.import': 'Importar Proyecto',
    'project.name': 'Nombre del Proyecto',
    'project.defaultName': 'Proyecto LuxSequencer',
    
    // Renderers
    'renderer.webgl': 'Escala WebGL',
    'renderer.canvas2d': 'Escala Canvas 2D',
    'renderer.concentric': 'Hex谩gonos Conc茅ntricos',
    
    // Sections
    'section.scale': 'Configuraci贸n de Escala',
    'section.animation': 'Animaci贸n',
    'section.appearance': 'Apariencia',
    'section.background': 'Fondo',
    'section.border': 'Borde',
    'section.concentric': 'Configuraci贸n Conc茅ntrica',
    
    // Viewport
    'viewport.default': 'Predeterminado',
    'viewport.desktop': 'Escritorio (1920x1080)',
    'viewport.mobile': 'M贸vil (390x844)',
    
    // Debug
    'debug.overlay': 'Overlay de Debug',
    'debug.fps': 'FPS: {{value}}',
    'debug.ticks': 'Ticks: {{count}}',
    'debug.step': 'Paso: {{current}}/{{total}}',
    'debug.animations': 'Animaciones Activas: {{count}}',
    'debug.export': 'Exportar Datos de Debug',
    
    // Validation/Errors
    'error.loadProject': 'Error al cargar proyecto',
    'error.saveProject': 'Error al guardar proyecto',
    'error.midiAccess': 'Acceso MIDI denegado',
    'error.invalidProject': 'Formato de proyecto inv谩lido'
  }
}
```

### 3.3. `src/i18n/index.ts`

```typescript
import { rosetta } from 'rosetta'
import { translations } from './translations'
import type { TranslationKeys, LocaleCode, TranslationParams } from './types'

// Crear instancia de rosetta con todas las traducciones
const r = rosetta<TranslationKeys>(translations)

// Detectar idioma inicial del navegador
const getBrowserLocale = (): LocaleCode => {
  const browserLang = navigator.language.split('-')[0]
  return (['en', 'es'] as LocaleCode[]).includes(browserLang as LocaleCode) 
    ? (browserLang as LocaleCode) 
    : 'en'
}

// Configurar idioma inicial
r.locale(getBrowserLocale())

// Exportar funciones principales
export const t = (key: keyof TranslationKeys, params?: TranslationParams): string => {
  return r.t(key, params) || key
}

export const setLocale = (locale: LocaleCode): void => {
  r.locale(locale)
}

export const getCurrentLocale = (): LocaleCode => {
  return r.locale() as LocaleCode
}

export const getAvailableLocales = (): LocaleCode[] => {
  return ['en', 'es']
}

export { type TranslationKeys, type LocaleCode, type TranslationParams }
```

### 3.4. `src/i18n/hooks/useTranslation.ts`

```typescript
import { useState, useCallback } from 'react'
import { t, setLocale, getCurrentLocale, getAvailableLocales } from '../index'
import type { TranslationKeys, LocaleCode, TranslationParams } from '../types'

export const useTranslation = () => {
  const [currentLocale, setCurrentLocale] = useState<LocaleCode>(getCurrentLocale())

  const translate = useCallback((key: keyof TranslationKeys, params?: TranslationParams): string => {
    return t(key, params)
  }, [])

  const changeLocale = useCallback((locale: LocaleCode) => {
    setLocale(locale)
    setCurrentLocale(locale)
  }, [])

  return {
    t: translate,
    locale: currentLocale,
    setLocale: changeLocale,
    availableLocales: getAvailableLocales()
  }
}
```

## 4. Integraci贸n con Zustand Store

### 4.1. Crear slice de i18n: `src/store/slices/i18n.slice.ts`

```typescript
import type { StateCreator } from 'zustand'
import { setLocale as setRosettaLocale, getCurrentLocale } from '../../i18n'
import type { LocaleCode } from '../../i18n/types'

export interface I18nSlice {
  // State
  locale: LocaleCode
  
  // Actions
  setLocale: (locale: LocaleCode) => void
}

export const createI18nSlice: StateCreator<
  I18nSlice,
  [],
  [],
  I18nSlice
> = (set) => ({
  // Initial state
  locale: getCurrentLocale(),
  
  // Actions
  setLocale: (locale: LocaleCode) => {
    setRosettaLocale(locale)
    set({ locale })
    
    // Persistir en localStorage
    localStorage.setItem('luxsequencer:locale', locale)
  }
})
```

### 4.2. Integrar en store principal: `src/store/index.ts`

Agregar el slice de i18n al store principal:

```typescript
// A帽adir import
import { createI18nSlice, type I18nSlice } from './slices/i18n.slice'

// Agregar a la interfaz principal
interface TextureStore extends 
  ProjectSlice,
  SettingsSlice,
  UISlice,
  SequencerSlice,
  MidiSlice,
  AnimationSlice,
  RecordingSlice,
  I18nSlice {} // <- A帽adir esta l铆nea

// Agregar al store
export const useTextureStore = create<TextureStore>()(
  subscribeWithSelector(
    immer((...a) => ({
      ...createProjectSlice(...a),
      ...createSettingsSlice(...a),
      ...createUISlice(...a),
      ...createSequencerSlice(...a),
      ...createMidiSlice(...a),
      ...createAnimationSlice(...a),
      ...createRecordingSlice(...a),
      ...createI18nSlice(...a), // <- A帽adir esta l铆nea
    }))
  )
)
```

### 4.3. Inicializaci贸n en `src/App.tsx`

A帽adir l贸gica de inicializaci贸n del idioma:

```typescript
// A帽adir al useEffect de inicializaci贸n existente
useEffect(() => {
  // ... c贸digo existente de initializeProject() ...
  
  // Inicializar idioma desde localStorage
  const savedLocale = localStorage.getItem('luxsequencer:locale') as LocaleCode
  if (savedLocale && ['en', 'es'].includes(savedLocale)) {
    setLocale(savedLocale)
  }
}, [])
```

## 5. Ejemplos de Uso en Componentes

### 5.1. Hook personalizado (Recomendado)

```typescript
import { useTranslation } from '../i18n/hooks/useTranslation'

const SequencerControls: React.FC = () => {
  const { t } = useTranslation()
  const { isPlaying, togglePlayback, bpm } = useTextureStore()
  
  return (
    <div>
      <button onClick={togglePlayback}>
        {isPlaying ? t('sequencer.stop') : t('sequencer.play')}
      </button>
      <span>{t('sequencer.bpm', { value: bpm })}</span>
    </div>
  )
}
```

### 5.2. Funci贸n importada directa

```typescript
import { t } from '../i18n'

const MidiLearnButton: React.FC<{ isLearning: boolean }> = ({ isLearning }) => {
  return (
    <button>
      {isLearning ? t('midi.learning') : t('midi.learn')}
    </button>
  )
}
```

### 5.3. Con par谩metros din谩micos

```typescript
const DebugOverlay: React.FC = () => {
  const { t } = useTranslation()
  const fps = 60
  const activeAnimationsCount = 3
  
  return (
    <div>
      <div>{t('debug.fps', { value: fps })}</div>
      <div>{t('debug.animations', { count: activeAnimationsCount })}</div>
    </div>
  )
}
```

## 6. Selector de Idioma Component

### 6.1. Crear `src/components/i18n/LanguageSelector.tsx`

```typescript
import React from 'react'
import { useTranslation } from '../../i18n/hooks/useTranslation'

export const LanguageSelector: React.FC<{ className?: string }> = ({ className }) => {
  const { locale, setLocale, availableLocales } = useTranslation()

  return (
    <select 
      value={locale} 
      onChange={(e) => setLocale(e.target.value as any)}
      className={className}
    >
      <option value="en">吼 English</option>
      <option value="es"> Espa帽ol</option>
    </select>
  )
}
```

### 6.2. Integrar en Header

A帽adir el selector de idioma al header existente:

```typescript
// En src/App.tsx, dentro del header
import { LanguageSelector } from './components/i18n/LanguageSelector'

// Agregar junto a otros controles del header
<LanguageSelector className="bg-black/80 text-white rounded px-2 py-1" />
```

## 7. Migraci贸n de Strings Existentes

### 7.1. Archivos Prioritarios para Migraci贸n

**Orden de implementaci贸n sugerido:**

1. **`src/components/sequencer/Sequencer.tsx`** - Controles principales del secuenciador
2. **`src/components/controls/ControlPanel.tsx`** - Panel de controles
3. **`src/components/midi/MidiLearnButton.tsx`** - Botones MIDI
4. **`src/components/shared/SequenceManager.tsx`** - Gesti贸n de secuencias
5. **`src/App.tsx`** - Header y controles principales

### 7.2. Patr贸n de Migraci贸n

**Antes:**
```typescript
<button onClick={togglePlayback}>
  {isPlaying ? 'Stop' : 'Play'}
</button>
```

**Despu茅s:**
```typescript
import { useTranslation } from '../i18n/hooks/useTranslation'

const { t } = useTranslation()

<button onClick={togglePlayback}>
  {isPlaying ? t('sequencer.stop') : t('sequencer.play')}
</button>
```

### 7.3. Strings en Control Schemas

Para los schemas de controles (e.g., `scale-texture-schema.ts`), usar la funci贸n `t` directa:

**Antes:**
```typescript
{ type: 'slider', id: 'scaleSize', label: 'Scale Size', min: 1, max: 200 }
```

**Despu茅s:**
```typescript
import { t } from '../../i18n'

{ type: 'slider', id: 'scaleSize', label: t('controls.scaleSize'), min: 1, max: 200 }
```

## 8. Testing y Validaci贸n

### 8.1. Test de Cambio de Idioma

1. Implementar selector de idioma en el header
2. Verificar que todos los textos cambien instant谩neamente
3. Verificar persistencia en localStorage al recargar

### 8.2. Test de Performance

1. Verificar que no hay impacto en FPS durante uso intensivo
2. Medir tiempo de lookup de traducciones (deber铆a ser < 1ms)

### 8.3. Test de Fallback

1. Eliminar temporalmente una traducci贸n en espa帽ol
2. Verificar que muestra la key como fallback

## 9. Checklist de Implementaci贸n

### Configuraci贸n Base
- [ ] Instalar `rosetta`
- [ ] Crear estructura de carpetas `src/i18n/`
- [ ] Implementar `translations.ts` con todos los strings
- [ ] Crear `index.ts` con configuraci贸n de rosetta
- [ ] Implementar `useTranslation` hook
- [ ] Crear slice de i18n para Zustand

### Integraci贸n
- [ ] Agregar slice al store principal
- [ ] Inicializar idioma en `App.tsx`
- [ ] Crear componente `LanguageSelector`
- [ ] A帽adir selector al header

### Migraci贸n
- [ ] Migrar `Sequencer.tsx`
- [ ] Migrar `ControlPanel.tsx` y schemas
- [ ] Migrar `MidiLearnButton.tsx`
- [ ] Migrar strings del header
- [ ] Migrar mensajes de error

### Testing
- [ ] Test de cambio de idioma en vivo
- [ ] Test de persistencia
- [ ] Test de fallbacks
- [ ] Verificar performance en tiempo real

## 10. Notas de Performance

- **Lookups instant谩neos**: rosetta usa Maps internos para O(1) lookup
- **Sin re-renders**: Cambio de idioma no causa re-renders innecesarios
- **Memoria**: ~2KB para todas las traducciones en memoria
- **Carga inicial**: +0.1s m谩ximo en el load inicial de la app

## 11. Extensiones Futuras

### Posibles mejoras a implementar despu茅s:

1. **Formateo de n煤meros**: Para BPM, steps, etc.
```typescript
'sequencer.bpm': 'BPM: {{value, number}}'
```

2. **Pluralizaci贸n**: Para contadores
```typescript
'sequencer.patterns': '{{count}} pattern{{count, plural, s}}'
```

3. **M谩s idiomas**: Franc茅s, alem谩n, etc.

4. **Interpolaci贸n avanzada**: Para textos m谩s complejos

## 12. Troubleshooting

### Problemas Comunes

1. **Keys no encontradas**: Verificar que la key existe en `TranslationKeys`
2. **Par谩metros no funcionan**: Verificar sintaxis `{{param}}`
3. **Cambio de idioma no se ve**: Verificar que el componente usa el hook
4. **Performance issues**: rosetta no deber铆a causar problemas, revisar otros factores

### Debug

```typescript
// En consola del navegador
console.log(getCurrentLocale()) // Idioma actual
console.log(t('sequencer.play')) // Test de traducci贸n
```